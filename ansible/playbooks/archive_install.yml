---
  - hosts: archive
    roles:
      - archive
    become: true
    tasks:
      - name: (Scorpio Test) Ensure dataflow exists
        file:
          path: "{{ dataflow_path }}"
          state: directory
          mode: 'u+rwx,g+rwx,o+rx'
          owner: fitsdata
          group: fitsdata
        when: "'arcdev' in inventory_hostname"
      - name: Check for dataflow folder
        stat:
          path: "{{ dataflow_path }}"
        register: dataflow_folder
        when: not is_s3 and not ignore_dataflow
      - name: Fail if dataflow folder missing
        fail:
          msg: "Dataflow folder not found"
        when: not dataflow_folder and not is_s3 and not ignore_dataflow
      - name: Check for DHS folder
        stat:
          path: /sci/dhs
        register: dhs_folder
        when: is_onsite and is_ops and not ignore_dhs
      - name: Fail if DHS folder missing
        fail:
          msg: "DHS folder not found"
        when: "not dhs_folder and ('mko' in inventory_hostname or 'cpofits-lv3' in inventory_hostname)"
# removing per Jose Varas, ITS should setup necessary packages/repos for us
#      - name: install EPEL
#        yum:
#          name:
#            - https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
#          state: present
#        when: ansible_distribution == 'CentOS' and ansible_distribution_version < '8' and install_epel
#      - name: Fail while I iterate
#        fail:
#          msg: "Exiting early"
#      - name: Setup EPEL
#        yum:
#          name:
#            - epel-release
#        when: install_epel
      - name: install packages
        yum:
          name: 
            - openssl
            - postgresql
            - postgresql-server
            - postgresql-devel
            - epel-release
            - gcc
            - gcc-c++
            - python3-devel
            - gcc-gfortran
            - cfitsio-devel
            - git
            - python3-pip
            - httpd
            - httpd-devel
            - redhat-rpm-config
            - make
          state: latest
      - name: install Repos for Sphinx (dnf-plugins)
#        # shell: "dnf config-manager --enable PowerTools AppStream BaseOS *epel"
#        shell: "dnf config-manager --enable PowerTools AppStream BaseOS"
#        shell: dnf --enablerepo=PowerTools install python3-sphinx
        yum:
          name:
            - dnf-plugins-core
          state: latest
        when: ansible_distribution == 'CentOS' and ansible_distribution_version >= '8'
#      - name: install Repos for Sphinx
#        shell: yum config-manager --set-enabled PowerTools
#        when: ansible_distribution == 'CentOS' and ansible_distribution_version >= '8'
      - name: install CentOS8 packages
        yum:
          name:
            - libnsl
#            - python3-sphinx
        when: ansible_distribution == 'CentOS' and ansible_distribution_version >= '8'
      - name: install Sphinx (have to pull direct from the mirror)
        yum:
          name:
            - http://mirror.centos.org/centos/8/PowerTools/x86_64/os/Packages/python3-sphinx-1.7.6-2.el8.noarch.rpm
            - http://mirror.centos.org/centos/8/PowerTools/x86_64/os/Packages/python3-sphinx-theme-alabaster-0.7.9-7.el8.noarch.rpm
            - http://mirror.centos.org/centos/8/PowerTools/x86_64/os/Packages/python-sphinx-locale-1.7.6-2.el8.noarch.rpm
            - http://mirror.centos.org/centos/8/PowerTools/x86_64/os/Packages/python3-mock-2.0.0-11.el8.noarch.rpm
            - http://mirror.centos.org/centos/8/PowerTools/x86_64/os/Packages/python3-packaging-16.8-9.el8.noarch.rpm
            - http://mirror.centos.org/centos/8/PowerTools/x86_64/os/Packages/python3-imagesize-1.0.0-2.el8.noarch.rpm
            - http://mirror.centos.org/centos/8/PowerTools/x86_64/os/Packages/python3-snowballstemmer-1.2.1-6.el8.noarch.rpm
            - http://mirror.centos.org/centos/8/PowerTools/x86_64/os/Packages/python3-sphinx_rtd_theme-0.3.1-3.el8.noarch.rpm
            - http://mirror.centos.org/centos/8/PowerTools/x86_64/os/Packages/python3-sphinxcontrib-websupport-1.0.1-10.20180316git.el8.noarch.rpm
            - http://mirror.centos.org/centos/8/PowerTools/x86_64/os/Packages/fontawesome-fonts-web-4.7.0-4.el8.noarch.rpm
            - http://mirror.centos.org/centos/8/PowerTools/x86_64/os/Packages/python3-whoosh-2.7.4-9.el8.noarch.rpm
          state: present
        when: build_sphinx
# tweak this to deploy when we are about to go live
      - name: install postfix
        yum:
          name:
            - postfix
        when: enable_postfix
        notify: restart postfix
      - name: configure postfix inet protocols
        lineinfile:
          path: /etc/postfix/main.cf
          line: inet_protocols = ipv4
          regex: inet_protocols
          create: yes
        when: enable_postfix
        notify: restart postfix
      - name: configure postfix relay in Hawaii
        lineinfile:
          path: /etc/postfix/main.cf
          line: relayhost = [smtp.hi.gemini.edu]:25
          regex: relayhost
          create: yes
        when: enable_postfix and is_hawaii
        notify: restart postfix
      - name: configure postfix relay in Chile
        lineinfile:
          path: /etc/postfix/main.cf
          line: relayhost = [smtp.cl.gemini.edu]:25
          regex: relayhost
          create: yes
        when: enable_postfix and is_chile
        notify: restart postfix
      - name: configure postfix in AWS
        copy:
          src: ../../otherfiles/postfix_main.cf
          dest: /etc/postfix/main.cf
        when: enable_postfix and is_aws
        notify: restart postfix
      - name: configure postfix transports in AWS
        copy:
          src: ../../otherfiles/postfix_transport
          dest: /etc/postfix/transport
        when: enable_postfix and is_aws
        register: updated_postfix_transport
      - name: Create postfix transport.db
        become: true
        become_user: root
        command: cd /etc/postfix && postmap transport
        when: updated_postfix_transport.changed
        notify: restart postfix
#      - name: target pip version due to bug
#        command: python3 -m pip install --upgrade "pip<10.0"
      - name: target pip version due to bug
        command: python3 -m pip install --upgrade
      - name: Ensure group "fitsdata" exists
        group:
          name: fitsdata
          gid: 5179
          state: present
      - name: Ensure group "geminidata" exists
        group:
          name: geminidata
          gid: 502
          state: present
      - name: Add the user 'fitsdata' with a specific uid and a primary group of 'fitsdata'
        user:
          name: fitsdata
          uid: 5179
      - name: Update user fitsdata groups to add fitsdata and geminidata
        user:
          name: fitsdata
          groups: fitsdata,geminidata
          append: yes
      - name: Update user apache groups to add fitsdata
        user:
          name: apache
          groups: fitsdata
          append: yes
      - name: Ensure FitsStorage/DB/GCM repo folders are available and permissioned
        file:
          path: '{{item}}'
          state: directory
          mode: 'u+rwx,g+rwx,o+rx'
          owner: fitsdata
          group: fitsdata
        with_items:
          - ["/opt/FitsStorageDB", "/opt/GeminiCalMgr", "/opt/FitsStorage"]
      - name: Checkout FitsStorageDB into /opt
        become: true
        become_user: fitsdata
        git:
          repo: "git@gitlab.gemini.edu:DRSoftware/FitsStorageDB.git"
          version: v1.0.0
          dest: /opt/FitsStorageDB
          accept_hostkey: yes
        when: not is_aws
        register: checkedout_fitsstoragedb
      - name: Checkout GeminiCalMgr into /opt
        become: true
        become_user: fitsdata
        git:
          repo: "git@gitlab.gemini.edu:DRSoftware/GeminiCalMgr.git"
          version: v1.1.0
          dest: /opt/GeminiCalMgr
          accept_hostkey: yes
        when: not is_aws
        register: checkedout_geminicalmgr
      - name: Checkout FitsStorage into /opt
        become: true
        become_user: fitsdata
        git:
          repo: "git@gitlab.gemini.edu:DRSoftware/FitsStorage.git"
          version: 2021-2
          dest: /opt/FitsStorage
          accept_hostkey: yes
        when: not is_aws
        notify: restart services
      - name: Rsync FitsStorageDB into /opt (AWS)
        become: false
        local_action:
          module: shell
          _raw_params: rsync -r --exclude .git -e "ssh -l fitsdata -2 -i ~/id_rsa" ../../../FitsStorageDB fitsdata@"{{ inventory_hostname }}".gemini.edu:/opt/FitsStorageDB/
        when: is_aws
        notify: restart services
        register: checkedout_fitsstoragedb
      - name: Rsync GeminiCalMgr into /opt (AWS)
        become: false
        local_action:
          module: shell
          _raw_params: rsync -r --exclude .git -e "ssh -l fitsdata -2 -i ~/id_rsa" ../../../GeminiCalMgr fitsdata@"{{ inventory_hostname }}".gemini.edu:/opt/GeminiCalMgr/
        when: is_aws
        register: checkedout_geminicalmgr
      - name: Install FitsStorageDB
        become: true
        command: bash -c "python3 setup.py install"
        args:
          chdir: /opt/FitsStorageDB
        when: checkedout_fitsstoragedb
        notify: restart services
      - name: Install GeminiCalMgr
        become: true
        command: bash -c "python3 setup.py install"
        args:
          chdir: /opt/GeminiCalMgr
        when: checkedout_geminicalmgr
        notify: restart services
      - name: Rsync FitsStorage into /opt (AWS)
        become: false
        local_action: 
          module: shell
          _raw_params: rsync -r --exclude .git -e "ssh -l fitsdata -2 -i ~/id_rsa" ../.. fitsdata@"{{ inventory_hostname }}".gemini.edu:/opt/FitsStorage/
        when: is_aws
        notify: restart services
      - name: Setup AWS config folder for localstack
        file:
          path: /usr/share/httpd/.aws
          state: directory
          mode: u+rwx,g+rwx,o+rwx
          owner: apache
          group: apache
        become: true
      - name: Setup aws config file for localstack
        copy:
          src: ../../otherfiles/dot_aws_config_for_miscfilesplus_localstack
          dest: ~apache/.aws/config
          owner: apache
      - name: install psycopg2 binary (so we don't have to compile it) (CentOS 7)
        command: bash -c "python -m pip install psycopg2-binary==2.8.4"
        when: ansible_distribution == 'CentOS' and ansible_distribution_version < '8'
      - name: install psycopg2 binary (so we don't have to compile it) (CentOS 8)
        command: bash -c "pip3 install psycopg2-binary==2.9.1"
        when: ansible_distribution == 'CentOS' and ansible_distribution_version >= '8'
      - name: install python packages
        command: bash -c "cd /opt/FitsStorage && pip3 install -r requirements.txt --upgrade"
      - name: install pip for python2 if on CentOS 7
        yum:
          name: 
            - python-pip
          state: latest
        when: ansible_distribution == 'CentOS' and ansible_distribution_version < '8'
      - name: install imexam for DRAGONS (Centos 8)
        command: bash -c "python3 -m pip install imexam specutils"
        when: ansible_distribution == 'CentOS' and ansible_distribution_version >= '8'
      - name: make dummy specutils folder to satisfy the library's bad logic
        file:
          path: /usr/share/httpd/.specutils
          state: directory
          mode: u+rwx,g+rwx,o+rwx
          owner: fitsdata
          group: fitsdata
        become: true
      - name: install imexam and specutils for DRAGONS (Centos 7)
        command: bash -c "python3 -m pip install imexam specutils"
        when: ansible_distribution == 'CentOS' and ansible_distribution_version < '8'
      - name: Create folders for FitsStorage to work with files
        file:
          path: '{{ item.path }}'
          state: directory
          mode: '{{ item.mode }}'
          owner: '{{ item.owner }}'
          group: '{{ item.group }}'
        with_items:
          - { path: /data/logs, owner: fitsdata, group: fitsdata, mode: "u+rwx,g+rwx,o+rwx" }
          - { path: /data/backups, owner: fitsdata, group: fitsdata, mode: "u+rwx,g-w,o-w" }
          - { path: /data/upload_staging, owner: fitsdata, group: fitsdata, mode: "u+rwx,g+rwx,o+rwx" }
          - { path: /data/z_staging, owner: fitsdata, group: fitsdata, mode: "u+rwx,g+rwx,o+rwx" }
          - { path: /data/s3_staging, owner: fitsdata, group: fitsdata, mode: "u+rwx,g+rwx,o+rwx" }
          - { path: /data/gemini_data, owner: fitsdata, group: fitsdata, mode: "u+rwx,g-w,o-w" }
      - name: Checkout DRAGONS into /opt
        git:
          repo: https://github.com/GeminiDRSoftware/DRAGONS.git
          dest: /opt/DRAGONS
          version: 201e1d04018af9769707aaf9d9260aea052e6345
          #version: release/3.0.x
        register: dragonscheckout
      - name: Cythonize DRAGONS
        command: /usr/local/bin/cythonize -3 -i cyclip.pyx
        args:
          chdir: /opt/DRAGONS/gempy/library/
        become: true
        become_user: root
        when: dragonscheckout.changed
      - name: Copy fitsverify to server
        copy:
          src: ../../fitsverify/
          dest: /opt/fitsverify/
          mode: u+rwx,g+rx,o+rx
        register: copiedfitsverify
      - name: Compile fitsverify
        command: gcc -L /lib64 -I /usr/include/cfitsio -o fitsverify ftverify.c fvrf_data.c fvrf_file.c fvrf_head.c fvrf_key.c fvrf_misc.c -DSTANDALONE -L. -lcfitsio -lm -lnsl-2.28
        args:
          chdir: /opt/fitsverify/
        when: copiedfitsverify.changed and ansible_distribution == 'CentOS' and ansible_distribution_version >= '8'
      - name: Compile fitsverify
        command: gcc -L /lib64 -I /usr/include/cfitsio -o fitsverify ftverify.c fvrf_data.c fvrf_file.c fvrf_head.c fvrf_key.c fvrf_misc.c -DSTANDALONE -L. -lcfitsio -lm -lnsl
        args:
          chdir: /opt/fitsverify/
        when: copiedfitsverify.changed and ansible_distribution == 'CentOS' and ansible_distribution_version < '8'
# unset SPHINXOPTS if you want to see all the warnings from sphinx
      - name: Build Sphinx documentation (hbffits-lv4 only)
        become: true
        become_user: fitsdata
        command: "env PATH=/usr/local/bin:$PATH make clean html"
        args:
          chdir: /opt/FitsStorage/sphinx
        environment:
          - PYTHONPATH: "/opt/GeminiCalMgr:/opt/FitsStorageDB:/opt/FitsStorage:/opt/DRAGONS"
          - SPHINXOPTS: "{{ sphinx_opts }}"
        when: build_sphinx
      - name: Build FitsStorageDB Sphinx documentation (hbffits-lv4 only)
        become: true
        become_user: fitsdata
        command: "env PATH=/usr/local/bin:$PATH make clean html"
        args:
          chdir: /opt/FitsStorageDB/sphinx
        environment:
          - PYTHONPATH: "/opt/GeminiCalMgr:/opt/FitsStorageDB:/opt/FitsStorage:/opt/DRAGONS"
          - SPHINXOPTS: "{{ sphinx_opts }}"
        when: build_sphinx
      - name: Build GeminiCalMgr Sphinx documentation (hbffits-lv4 only)
        become: true
        become_user: fitsdata
        command: "env PATH=/usr/local/bin:$PATH make clean html"
        args:
          chdir: /opt/GeminiCalMgr/sphinx
        environment:
          - PYTHONPATH: "/opt/GeminiCalMgr:/opt/FitsStorageDB:/opt/FitsStorage:/opt/DRAGONS"
          - SPHINXOPTS: "{{ sphinx_opts }}"
        when: build_sphinx
      - name: Build Sphinx documentation (hbffits-lv4 only)
        become: true
        become_user: fitsdata
        command: "env PATH=/usr/local/bin:$PATH make clean html"
        args:
          chdir: /opt/FitsStorage/sphinx
        environment:
          - PYTHONPATH: "/opt/FitsStorage:/opt/DRAGONS"
          - SPHINXOPTS: "{{ sphinx_opts }}"
        when: build_sphinx
      - name: Setup PostgreSQL data directory
        file:
          path: /data/pgsql_data
          state: directory
          owner: postgres
          group: postgres
      - name: Install PostgreSQL service script
        command: cp /lib/systemd/system/postgresql.service /etc/systemd/system/
        args:
          creates: /etc/systemd/system/postgresql.service
        register: postgresql_service_installed
      - name: Configure PostgreSQL environment
        lineinfile:
          path: /etc/systemd/system/postgresql.service
          line: Environment=PGDATA=/data/pgsql_data
          regex: Environment=PGDATA
          create: yes
        register: postgresql_configured
# onsite doesn't seem to like this, needed it for arcdev - TODO conditional?
#      - name: Configure SELinux for PostgresSQL
#        command: chcon -R -t postgresql_db_t  /data/pgsql_data
#        when: postgresql_configured
      - name: Reload System Daemons
        command: systemctl daemon-reload
        when: postgresql_configured.changed or postgresql_service_installed.changed
      - name: Initialize PostgreSQL database
        command: bash -c "/usr/bin/postgresql-setup initdb"
        when: postgresql_configured.changed or postgresql_service_installed.changed
        become: true
        become_user: root
      - name: Configure PostgreSQL shared buffers
        lineinfile:
          path: /data/pgsql_data/postgresql.conf
          line: shared_buffers = 1024MB
          regex: shared_buffers =
          create: yes
        register: postgresql_configured
      - name: Bounce PostgreSQL before building db
        service: name=postgresql state=restarted enabled=yes
      - name: Ensure we have fitsdata user with access to database
        postgresql_user: 
          name=fitsdata
          password=fitsdata
          state=present
        become: yes
        become_user: postgres
      - name: Ensure we have the fitsdata database
        postgresql_db: name=fitsdata
          encoding='UTF-8'
          lc_collate='en_US.UTF-8'
          lc_ctype='en_US.UTF-8'
          state=present
          owner=fitsdata
        register: fitsdata_db_created
        become: yes
        become_user: postgres
      - name: Update cache size for database
        lineinfile:
          path: /data/pgsql_data/postgresql.conf
          line:    effective_cache_size = 8000MB
          regex: effective_cache_size
          create: yes
      - name: Bounce PostgreSQL to get updated configuration
        service: name=postgresql state=restarted enabled=yes
        when: postgresql_configured.changed or postgresql_service_installed.changed
      - name: Enable PostgreSQL on startup
        service: name=postgresql enabled=yes
      - name: Create tables in DB
        command: bash -c "cd /opt/FitsStorage && env PYTHONPATH=/opt/DRAGONS:/opt/FitsStorage:/opt/GeminiCalMgr:/opt/FitsStorageDB python3 ./fits_storage/scripts/create_tables.py"
        become: yes
        become_user: fitsdata
        when: fitsdata_db_created.changed
#      - name: Create Materialized Views
#        postgresql_query:
#          db: fitsdata
#          login_user: fitsdata
#          path_to_script: /opt/FitsStorage/sql/views.sql
#        become: yes
#        become_user: fitsdata
#        when: ansible_distribution == 'CentOS' and ansible_distribution_version >= '8'
      - name: Setup Migrations
        command: bash -c "cd /opt/FitsStorage/ && env PYTHONPATH=/opt/DRAGONS:/opt/FitsStorage python3 dbmigration/manage.py version_control postgresql:///fitsdata dbmigration"
        become: yes
        become_user: postgres
        when: fitsdata_db_created.changed
      - name: If we have a fresh DB, set version to 24 since we are already up to date with the migrations
        postgresql_query:
          db: fitsdata
          query: update migrate_version set version=24
        become: yes
        become_user: postgres
        when: fitsdata_db_created.changed
      - name: Apply Migrations (Idempotent, always apply)
        command: bash -c "cd /opt/FitsStorage/ && env PYTHONPATH=/opt/DRAGONS:/opt/FitsStorage python3 dbmigration/manage.py upgrade postgresql:///fitsdata dbmigration"
        become: yes
        become_user: fitsdata
        when: apply_migrations
      - name: Ensure we have apache user with access to database
        postgresql_user: db=fitsdata
          name=apache
          password=apache
          priv=ALL
          state=present
        become: yes
        become_user: postgres
      - name: Ensure we have root user with access to database
        postgresql_user: db=fitsdata
          name=root
          priv=ALL
          state=present
        become: yes
        become_user: postgres
      - name: WORKAROUND Grant PostgreSQL table access to apache
        postgresql_query:
          db: fitsdata
          query: GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO apache   
        become: yes
        become_user: postgres
      - name: WORKAROUND Grant PostgreSQL sequence access to apache
        postgresql_query:
          db: fitsdata
          query: GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO apache
        become: yes
        become_user: postgres
      # - name: Grant PostgreSQL table access to apache
      #   postgresql_privs:
      #     db: fitsdata
      #     privs: ALL
      #     type: table
      #     objs: ALL_IN_SCHEMA
      #     role: apache
      #   become: yes
      #   become_user: postgres
      # - name: Grant PostgreSQL sequence access to apache
      #   postgresql_privs:
      #     db: fitsdata
      #     privs: ALL
      #     type: sequence
      #     objs: ALL_IN_SCHEMA
      #     role: apache
      #   become: yes
      #   become_user: postgres
      - name: Install ingest queue 1
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-service_ingest_queue1.service
          dest: /etc/systemd/system/fits-service_ingest_queue1.service
        when: enable_ingest_services
      - name: Install ingest queue 2
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-service_ingest_queue2.service
          dest: /etc/systemd/system/fits-service_ingest_queue2.service
        when: enable_ingest_services
      - name: Install ingest queue 3
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-service_ingest_queue.service
          dest: /etc/systemd/system/fits-service_ingest_queue3.service
        when: is_archive and enable_ingest_services
      - name: Setup ingest 3
        lineinfile:
          path: /etc/systemd/system/fits-service_ingest_queue3.service
          line: Description=Fits Service Ingest Queue 3
          regex: Description=
          create: no
        when: is_archive and enable_ingest_services
      - name: Setup ingest 3 exec
        lineinfile:
          path: /etc/systemd/system/fits-service_ingest_queue3.service
          line: ExecStart=/usr/bin/python3 /opt/FitsStorage/fits_storage/scripts/service_ingest_queue.py --demon --lockfile --name=siq3
          regex: ExecStart=
          create: no
        when: is_archive and enable_ingest_services
      - name: Install ingest queue 4
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-service_ingest_queue.service
          dest: /etc/systemd/system/fits-service_ingest_queue4.service
        when: is_archive and enable_ingest_services
      - name: Setup ingest 4
        lineinfile:
          path: /etc/systemd/system/fits-service_ingest_queue4.service
          line: Description=Fits Service Ingest Queue 4
          regex: Description=
          create: no
        when: is_archive and enable_ingest_services
      - name: Setup ingest 4 exec
        lineinfile:
          path: /etc/systemd/system/fits-service_ingest_queue4.service
          line: ExecStart=/usr/bin/python3 /opt/FitsStorage/fits_storage/scripts/service_ingest_queue.py --demon --lockfile --name=siq4
          regex: ExecStart=
          create: no
        when: is_archive and enable_ingest_services
      - name: Install preview queue 1
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-service_preview_queue.service
          dest: /etc/systemd/system/fits-service_preview_queue1.service
        when: is_archive
      - name: Setup preview 1
        lineinfile:
          path: /etc/systemd/system/fits-service_preview_queue1.service
          line: Description=Fits Service Preview Queue 1
          regex: Description=
          create: no
        when: is_archive
      - name: Setup preview 1 exec
        lineinfile:
          path: /etc/systemd/system/fits-service_preview_queue1.service
          line: ExecStart=/usr/bin/python3 /opt/FitsStorage/fits_storage/scripts/service_preview_queue.py --demon --lockfile --name=spq1
          regex: ExecStart=
          create: no
        when: is_archive
      - name: Install preview queue 2
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-service_preview_queue.service
          dest: /etc/systemd/system/fits-service_preview_queue2.service
        when: is_archive
      - name: Setup preview 2
        lineinfile:
          path: /etc/systemd/system/fits-service_preview_queue2.service
          line: Description=Fits Service Preview Queue 2
          regex: Description=
          create: no
        when: is_archive
      - name: Setup preview 2 exec
        lineinfile:
          path: /etc/systemd/system/fits-service_preview_queue2.service
          line: ExecStart=/usr/bin/python3 /opt/FitsStorage/fits_storage/scripts/service_preview_queue.py --demon --lockfile --name=spq2
          regex: ExecStart=
          create: no
        when: is_archive
      - name: Install preview queue 3
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-service_preview_queue.service
          dest: /etc/systemd/system/fits-service_preview_queue3.service
        when: is_archive
      - name: Setup preview 3
        lineinfile:
          path: /etc/systemd/system/fits-service_preview_queue3.service
          line: Description=Fits Service Preview Queue 3
          regex: Description=
          create: no
        when: is_archive
      - name: Setup preview 3 exec
        lineinfile:
          path: /etc/systemd/system/fits-service_preview_queue3.service
          line: ExecStart=/usr/bin/python3 /opt/FitsStorage/fits_storage/scripts/service_preview_queue.py --demon --lockfile --name=spq3
          regex: ExecStart=
          create: no
        when: is_archive
      - name: Install preview queue 4
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-service_preview_queue.service
          dest: /etc/systemd/system/fits-service_preview_queue4.service
        when: is_archive
      - name: Setup preview 4
        lineinfile:
          path: /etc/systemd/system/fits-service_preview_queue4.service
          line: Description=Fits Service Preview Queue 4
          regex: Description=
          create: no
        when: is_archive
      - name: Setup preview 4 exec
        lineinfile:
          path: /etc/systemd/system/fits-service_preview_queue4.service
          line: ExecStart=/usr/bin/python3 /opt/FitsStorage/fits_storage/scripts/service_preview_queue.py --demon --lockfile --name=spq4
          regex: ExecStart=
          create: no
        when: is_archive
      - name: Install calcache queue 1
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-service_calcache_queue.service
          dest: /etc/systemd/system/fits-service_calcache_queue1.service
        when: is_archive
      - name: Install export queue
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-service_export_queue1.service
          dest: /etc/systemd/system/fits-service_export_queue1.service
      - name: Install API backend
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-api-backend.service
          dest: /etc/systemd/system/fits-api-backend.service
      - name: Install Copy From DHS Service
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-copy_from_dhs.service
          dest: /etc/systemd/system/fits-copy_from_dhs.service
      - name: Install Copy From Visiting Instrument MKO Service
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-copy_from_visiting_instruments_mko.service
          dest: /etc/systemd/system/fits-copy_from_visiting_instruments_mko.service
        when: is_ops and is_hawaii
      - name: Install Copy From Visiting Instrument CPO Service
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-copy_from_visiting_instruments_cpo.service
          dest: /etc/systemd/system/fits-copy_from_visiting_instruments_cpo.service
        when: is_ops and is_chile
      - name: Install fitsstorage config
        copy:
          src: ../../../FitsStorageConfig/configs/{{ inventory_hostname_short }}_fitsstorage.conf
          dest: /etc/fitsstorage.conf
        register: fitsstorageconf
        notify: restart services
      - name: Register Ingest service 1
        service: name=fits-service_ingest_queue1 state=started enabled=yes
        when: enable_ingest_services
      - name: Register Ingest service 2
        service: name=fits-service_ingest_queue2 state=started enabled=yes
        when: enable_ingest_services
      - name: Register Ingest service 3
        service: name=fits-service_ingest_queue3 state=started enabled=yes
        when: enable_all_ingest and enable_ingest_services
      - name: Register Ingest service 4
        service: name=fits-service_ingest_queue4 state=started enabled=yes
        when: enable_all_ingest and enable_ingest_services
      - name: Register Preview service 1
        service: name=fits-service_preview_queue1 state=started enabled=yes
        when: enable_preview
      - name: Register Preview service 2
        service: name=fits-service_preview_queue2 state=started enabled=yes
        when: enable_preview
      - name: Register Preview service 3
        service: name=fits-service_preview_queue3 state=started enabled=yes
        when: enable_preview
      - name: Register Preview service 4
        service: name=fits-service_preview_queue4 state=started enabled=yes
        when: enable_preview
      - name: Register Export Queue
        service: name=fits-service_export_queue1 state=started enabled=yes
        when: enable_export
      - name: Register Export Queue (hbf)
        service: name=fits-service_export_queue1 state=stopped enabled=no
        when: not enable_export
      - name: Register CalCache service 1
        service: name=fits-service_calcache_queue1 state=started enabled=yes
        when: is_archive
      - name: Register API service
        service: name=fits-api-backend state=started enabled=yes
      - name: Register DHS service
        service: name=fits-copy_from_dhs state=started enabled=yes
        when: is_ops and is_onsite
      - name: Un-Register DHS service
        service: name=fits-copy_from_dhs state=stopped enabled=no
        when: not is_ops or not is_onsite
      - name: Register Visiting Instrument CPO service
        service: name=fits-copy_from_visiting_instruments_cpo.service state=started enabled=yes
        when: is_ops and is_chile
      - name: Register Visiting Instrument MKO service
        service: name=fits-copy_from_visiting_instruments_mko.service state=started enabled=yes
        when: is_ops and is_hawaii
      - name: Register postfix service
        service: name=postfix state=started enabled=yes
        when: enable_postfix
      - name: install webserver packages
        yum:
          name: 
            - httpd
            - httpd-devel
            - mod_ssl
          state: latest
      - name: Install mod_wsgi
        # built in pip seems to be busted for Ansible+CentOS8
        command: python3 -m pip install "mod_wsgi"
      - name: Setup modwsgi directory
        file:
          path: /opt/modwsgi-default
          state: directory
      - name: setup mod-wsgi
        command: /usr/local/bin/mod_wsgi-express setup-server --server-root /opt/modwsgi-default --port 80 --user apache --group apache --access-log --url-alias /static /opt/FitsStorage/htmldocroot --url-alias /favicon.ico /opt/FitsStorage/htmldocroot/favicon.ico --url-alias /robots.txt /opt/FitsStorage/htmldocroot/robots.txt --python-path /opt/FitsStorage --python-path /opt/DRAGONS  --proxy-mount-point /rest http://127.0.0.1:8090/rest /opt/FitsStorage/fits_storage/wsgihandler.py
        args:
          creates: /opt/modwsgi-default/default.wsgi
        register: mod_wsgi_setup
      - name: Update mod-wsgi folder permissions
        file:
          path: /opt/modwsgi-default
          state: directory
          recurse: yes
          owner: apache
          group: apache
        when: mod_wsgi_setup.changed
      - name: Copy HTTPD service script
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-httpd.service
          dest: /etc/systemd/system/fits-httpd.service
      - name: Copy API service script
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-api-backend.service
          dest: /etc/systemd/system/fits-api-backend.service
      - name: Copy HTTPD config
        copy:
          src: ../../otherfiles/etc-sysconfig-httpd
          dest: /etc/sysconfig/httpd
      # TODO this is a complex XML patch if we try to apply it to the default file
      - name: Copy Mod-WSGI HTTPD config
        copy:
          src: ../../otherfiles/httpd-patched-centos8.conf
          dest: /opt/modwsgi-default/httpd.conf
        notify: restart services
        when: not is_aws
      - name: (ARCHIVE/ARCDEV) Copy Mod-WSGI HTTPD config
        copy:
          src: ../../otherfiles/archive-httpd.conf
          dest: /opt/modwsgi-default/httpd.conf
        notify: restart services
        when: "'archive' in inventory_hostname"
      - name: (ARCDEV) Copy Mod-WSGI Pre-SSL HTTPD config
        copy:
          src: ../../otherfiles/pressl-arcdev-httpd.conf
          dest: /opt/modwsgi-default/httpd.conf
        notify: restart services
        when: "'arcdev' in inventory_hostname"
      - name: Set WSGI entry point
        lineinfile:
          path: /opt/modwsgi-default/handler.wsgi
          line: entry_point = '/opt/FitsStorage/fits_storage/wsgihandler.py'
          regex: "^entry_point = "
        notify: restart services
      - name: Update mod-wsgi folder permissions
        file:
          path: /opt/modwsgi-default
          state: directory
          recurse: yes
          owner: apache
          group: apache
      - name: Install CertBot and associated
        yum:
          name: 
            - certbot 
            - python3-certbot-apache
            - mod_ssl
          state: latest
        when: enable_certbot
      - name: (ARCDEV) Setup Let's Encrypt
        command: certbot certonly --webroot -w /opt/modwsgi-default/htdocs/ -d arcdev.gemini.edu
        args:
          creates: /etc/letsencrypt
        notify: restart fits-httpd
        when: "'arcdev' in inventory_hostname"
      - name: (ARCDEV) Copy Mod-WSGI HTTPD config
        copy:
          src: ../../otherfiles/arcdev-httpd.conf
          dest: /opt/modwsgi-default/httpd.conf
        notify: restart services
        when: "'arcdev' in inventory_hostname"
#      - name: (ARCHIVE) Setup Let's Encrypt
#        command: certbot certonly --webroot -w /opt/modwsgi-default/htdocs/ -d archive.gemini.edu
#        args:
#          creates: /etc/letsencrypt
#        notify: restart fits-httpd
#        when: "'archive' in inventory_hostname"
      - name: Start WSGI service on boot
        service: name=fits-httpd enabled=yes
      - name: Start API service on boot
        service: name=fits-api-backend enabled=yes
# TODO diskspace script references mko folder, causing mount from Chile - fix then add this back in
#      - name: Copy diskspace script
#        copy:
#          src: ../../otherfiles/diskspace.py
#          dest: /home/fitsdata/diskspace.py
#          owner: fitsdata
#          group: fitsdata
#          mode: u+rwx,g-rwx,o-rwx
# removing for now, we had to revert to user cron
# Chile setup fitsdata user cron support for me
#      - name: Copy Crontab
#        copy:
#          src: ../../otherfiles/system_crontab
#          dest: /etc/cron.d/fitsstorage
#          owner: root
#          group: root
#          mode: 0644
#        register: cron_installed
#        notify: restart cron
#        when: "'arc' not in inventory_hostname"
#      - name: Copy Crontab
#        copy:
#          src: ../../otherfiles/system_crontab
#          dest: /var/spool/cron/fitsdata
#          force: no
#          owner: fitsdata
#          group: fitsdata
#          mode: 0600
#        register: cron_installed
#        notify: restart cron
#        when: "'mkofits-lv3' in inventory_hostname or 'cpofits-lv3' in inventory_hostname"
#      - name: Update cron for cpo
#        lineinfile:
#          path: /etc/cron.d/fitsstorage
#          line: 50 7 * * * python3 /opt/FitsStorage/fits_storage/scripts/get_notifications_from_odb.py --demon --odb=gnodb --semester=auto
#          regex: "^50 7 * * * python3 /opt/FitsStorage/fits_storage/scripts/get_notifications_from_odb.py"
#        notify: restart cron
#        when: cron_installed.changed and 'cpofits-lv3' in inventory_hostname
    handlers:
      - name: restart fits-api-backend
        service: name=fits-api-backend state=restarted
        listen: "restart services"
      - name: restart fits-httpd
        service: name=fits-httpd state=restarted
        listen: "restart services"
      - name: restart ingest1
        service: name=fits-service_ingest_queue1 state=restarted
        listen: "restart services"
        when: enable_ingest_services
      - name: restart ingest2
        service: name=fits-service_ingest_queue2 state=restarted
        listen: "restart services"
        when: enable_ingest_services
      - name: restart ingest3
        service: name=fits-service_ingest_queue3 state=restarted
        listen: "restart services"
        when: enable_all_ingest
      - name: restart ingest4
        service: name=fits-service_ingest_queue4 state=restarted
        listen: "restart services"
        when: enable_all_ingest
      - name: restart preview1
        service: name=fits-service_preview_queue1 state=restarted
        listen: "restart services"
        when: enable_preview
      - name: restart preview2
        service: name=fits-service_preview_queue2 state=restarted
        listen: "restart services"
        when: enable_preview
      - name: restart preview3
        service: name=fits-service_preview_queue3 state=restarted
        listen: "restart services"
        when: enable_preview and enable_all_preview
      - name: restart preview4
        service: name=fits-service_preview_queue4 state=restarted
        listen: "restart services"
        when: enable_preview and enable_all_preview
      - name: restart cron
        service: name=crond state=restarted
      - name: restart postfix
        service: name=postfix state=restarted
