---
  - hosts: all
    vars_files:
      - secret
    become: true
    tasks:
      - name: install packages
        yum:
          name: 
            - openssl
            - postgresql
            - postgresql-devel
            - epel-release
            - gcc
            - gcc-c++
            - python-devel
            - gcc-gfortran
            - cfitsio-devel
            - git
            - python-pip
          state: latest
      - name: upgrade pip
        pip:
          name:
            - pip
          extra_args: --upgrade
      - name: install python packages
        pip:
          name:
            - psycopg2
            - sqlalchemy
            - pyyaml
            - jinja2
            - pyfits
            - dateutils
            - requests
            - matplotlib
            - scipy
            - pandas
            - astropy
            - future
            - boto3
          state: latest
      - name: Ensure group "fitsdata" exists
        group:
          name: fitsdata
          gid: 5179
          state: present
      - name: Ensure group "geminidata" exists
        group:
          name: geminidata
          gid: 502
          state: present
      # - name: Centos 7 Fix (post create groups geminidata/fitsdata)
      #   command: sss_cache -E
      - name: Add the user 'fitsdata' with a specific uid and a primary group of 'fitsdata'
        user:
          name: fitsdata
          uid: 5179
      # - name: Centos 7 Fix (post-create user fitsdata)
      #   command: sss_cache -E
      - name: Update user fitsdata groups to add fitsdata and geminidata
        user:
          name: fitsdata
          groups: fitsdata,geminidata
          append: yes
      # - name: Centos 7 Fix (post-create user fitsdata)
      #   command: sss_cache -E
      - name: Set PYTHONPATH for fitsdata user for convenience
        lineinfile:
          path: /home/fitsdata/.cshrc
          line: setenv PYTHONPATH /opt/DRAGONS:/opt/FitsStorage
          regex: PYTHONPATH
          create: yes
      - name: Create folders for FitsStorage to work with files
        file:
          path: '{{ item.path }}'
          state: directory
          mode: '{{ item.mode }}'
          owner: '{{ item.owner }}'
        with_items:
          - { path: /data/logs, owner: fitsdata, mode: u+rwx,g-w,o-w }
          - { path: /data/backups, owner: fitsdata, mode: u+rwx,g-w,o-w }
          - { path: /data/upload_staging, owner: fitsdata, mode: u+rwx,g-w,o-w }
          - { path: /data/z_staging, owner: fitsdata, mode: u+rwx,g-w,o-w }
          - { path: /data/s3_staging, owner: fitsdata, mode: u+rwx,g+rw,o+rw }
          - { path: /data/gemini_data, owner: fitsdata, mode: u+rwx,g-w,o-w }
      - name: Checkout DRAGONS into /opt
        git:
          repo: https://github.com/GeminiDRSoftware/DRAGONS.git
          dest: /opt/DRAGONS
          key_file: id_rsa
      #- name: Checkout FitsStorage into /opt
      #  subversion:
      #    repo: http://scisoft/svn/FitsStorage/branches/dev-oly-tests
      #    dest: /opt/FitsStorage
      #    update: no
      - name: Copy key to server
        copy:
          src: id_rsa
          dest: /opt/id_rsa
          mode: u+rw,g-rw,o-rw
      - name: Checkout FitsStorage into /opt
        git:
          repo: "git@gitlab.gemini.edu:DRSoftware/FitsStorage.git"
          version: dev-oly-tests
          dest: /opt/FitsStorage
          #key_file: /opt/id_rsa
          ssh_opts: -i /opt/id_rsa
          accept_hostkey: yes
      - name: Remove key
        file:
          path: /opt/id_rsa
          state: absent
      - name: Change FitsStorage owner to fitsdata
        file:
          path: /opt/FitsStorage
          state: directory
          recurse: yes
          owner: fitsdata
      - name: Copy fitsverify to server
        copy:
          src: ../../fitsverify/
          dest: /opt/fitsverify/
      - name: Setup PostgreSQL data directory
        file:
          path: /data/pgsql_data
          state: directory
          owner: postgres
          group: postgres
      - name: Install PostgreSQL service script
        command: cp /lib/systemd/system/postgresql.service /etc/systemd/system/
        args:
          creates: /etc/systemd/system/postgresql.service
        register: postgresql_service_installed
      - name: Configure PostgreSQL environment
        lineinfile:
          path: /etc/systemd/system/postgresql.service
          line: Environment=PGDATA=/data/pgsql_data
          regex: Environment=PGDATA
          create: yes
        register: postgresql_configured
      - name: Ensure PostgreSQL is running
        service: name=postgresql state=started enabled=yes
      - name: Ensure we have the fitsdata database
        sudo_user: postgres
        postgresql_db: name=fitsdata
          encoding='UTF-8'
          lc_collate='en_US.UTF-8'
          lc_ctype='en_US.UTF-8'
          state=present
          owner=fitsdata
        register: fitsdata_db_created
      - name: Ensure we have fitsdata user with access to database
        sudo_user: postgres
        postgresql_user: db=fitsdata
          name=fitsdata
          password=fitsdata
          priv=ALL
          state=present
      - name: Update cache size for database
        lineinfile:
          path: /data/pgsql_data/postgresql.conf
          line:    effective_cache_size = 8000MB
          regex: effective_cache_size
          create: yes
      - name: Bounce PostgreSQL to get updated configuration
        service: name=postgresql state=restarted enabled=yes
        when: postgresql_configured.changed or postgresql_service_installed.changed
      - name: Enable PostgreSQL on startup
        service: name=postgresql enabled=yes
      - name: Set as a non-archive host and set storage_root
        lineinfile:
          path: /opt/FitsStorage/fits_storage/fits_storage_config.py
          line: use_as_archive=False
          regex: use_as_archive
          create: yes
      - name: Set storage_root
        lineinfile:
          path: /opt/FitsStorage/fits_storage/fits_storage_config.py
          line: storage_root = '/data/gemini_data'
          regex: storage_root
          create: yes
      - name: Create tables in DB
        sudo_user: fitsdata
        command: bash -c "cd /opt/FitsStorage && env PYTHONPATH=/opt/DRAGONS:/opt/FitsStorage python ./fits_storage/scripts/create_tables.py"
        when: fitsdata_db_created.changed
      - name: Ensure we have apache user with access to database
        sudo_user: postgres
        postgresql_user: db=fitsdata
          name=apache
          password=apache
          priv=ALL
          state=present
      - name: Ensure we have root user with access to database
        sudo_user: postgres
        postgresql_user: db=fitsdata
          name=root
          priv=ALL
          state=present
      - name: Grant PostgreSQL table access to apache
        sudo_user: postgres
        postgresql_privs:
          db: fitsdata
          privs: ALL
          type: table
          objs: ALL_IN_SCHEMA
          role: apache
      - name: Grant PostgreSQL sequence access to apache
        sudo_user: postgres
        postgresql_privs:
          db: fitsdata
          privs: ALL
          type: sequence
          objs: ALL_IN_SCHEMA
          role: apache
      - name: Install ingest queue 1
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-service_ingest_queue1.service
          dest: /etc/systemd/system/fits-service_ingest_queue1.service
      # TODO need to stop/start service #2 to do this, plus add a line replace
      # - name: Install ingest queue 2
      #   copy:
      #     src: ../../otherfiles/etc_systemd_system_fits-service_ingest_queue1.service
      #     dest: /etc/systemd/system/fits-service_ingest_queue2.service
      # - name: Install export queue
      #   copy:
      #     src: ../../otherfiles/etc_systemd_system_fits-service_export_queue1.service
      #     dest: /etc/systemd/system/fits-service_export_queue1.service
      - name: Install API backend
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-api-backend.service
          dest: /etc/systemd/system/fits-api-backend.service
      - name: Register Ingest service 1
        service: name=fits-service_ingest_queue1 state=started enabled=yes
      # - name: Register Export Queue
      #   service: name=fits-service_export_queue1 state=started enabled=yes
      - name: Register API service
        service: name=fits-api-backend state=started enabled=yes
      - name: install webserver packages
        yum:
          name: 
            - httpd
            - httpd-devel
            - mod_ssl
          state: latest
      - name: Install mod_wsgi
        pip:
          name:
            - mod_wsgi==4.6.5
          state: latest
      - name: Setup PostgreSQL data directory
        file:
          path: /opt/modwsgi-default
          state: directory
      - name: setup mod-wsgi
        command: mod_wsgi-express setup-server --server-root /opt/modwsgi-default --port 80 --user apache --group apache --access-log --url-alias /static /opt/FitsStorage/htmldocroot --url-alias /favicon.ico /opt/FitsStorage/htmldocroot/favicon.ico --url-alias /robots.txt /opt/FitsStorage/htmldocroot/robots.txt --python-path /opt/FitsStorage --python-path /opt/DRAGONS  /opt/FitsStorage/fits_storage/wsgihandler.py
        args:
          creates: /opt/modwsgi-default/default.wsgi
        register: mod_wsgi_setup
      - name: Update mod-wsgi folder permissions
        file:
          path: /opt/modwsgi-default
          state: directory
          recurse: yes
          owner: apache
          group: apache
        when: mod_wsgi_setup.changed
      - name: Copy HTTPD service script
        copy:
          src: ../../otherfiles/etc_systemd_system_fits-httpd.service
          dest: /etc/systemd/system/fits-httpd.service
      - name: Copy HTTPD config
        copy:
          src: ../../otherfiles/etc-sysconfig-httpd
          dest: /etc/sysconfig/httpd
      # TODO this is a complex XML patch if we try to apply it to the default file
      - name: Copy Mod-WSGI HTTPD config
        copy:
          src: ../../otherfiles/httpd-patched.conf
          dest: /opt/modwsgi-default/httpd.conf
        register: mod_wsgi_config_installed
      - name: Set WSGI entry point
        lineinfile:
          path: /opt/modwsgi-default/handler.wsgi
          line: entry_point = '/opt/FitsStorage/fits_storage/wsgihandler.py'
          regex: "^entry_point = "
        register: mod_wsgi_entry_point
      - name: Restart WSGI service
        service: name=fits-httpd state=restarted
        #when: mod_wsgi_config_installed.changed or mod_wsgi_entry_point.changed
      - name: Start WSGI service on boot
        service: name=fits-httpd enabled=yes

